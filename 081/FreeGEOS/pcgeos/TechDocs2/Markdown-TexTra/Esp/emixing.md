## E Cとアセンブリの混合

GocとEspのコードを1つのアプリケーションに結合したい場合があります。
これを実行したい場合は主に2つあります。
Gocでアプリケーションを作成していても、アプリケーションがいくつかの重要なルーチンに多くの時間を費やしている場合があります。この場合、これらのいくつかのルーチンをアセンブリで書き直すことで、効率を向上させることができます。
アプリケーションの残りの部分を書き直したくない場合は、Cから呼び出すことができるように、これらのルーチンを作成する必要があります。

一方、時間のかかるルーチンがたくさんあるライブラリーを作成している場合もあります。
この場合、Gocインターフェースを維持しながら、アセンブリ内のライブラリ全体を書き直すことに価値があると思うかもしれません。
そうすれば、ライブラリを使用するすべてのアプリケーションは、アセンブリコードの効率を利用できるようになる。
(たとえば、ほとんどのGEOSシステムライブラリはアセンブリで作成されています)。

特に、多くの異なるアプリケーションで使用されている新しいオブジェクトクラスを設計する場合、そのオブジェクトクラスを定義するライブラリを作成することは価値があります。
Gocインターフェイスを提供しながら、すべてのメソッドコードをアセンブリで記述することができます。これにより、クラスを使用するすべてのアプリケーションで、アセンブリの効率性を活用できます。

### E.1 Goc GeodeへのESPコードの追加

ほとんどの人は、Gocでアプリケーションを書くのが一番簡単だと思うでしょう。ほとんどの目的に対して、Gocは十分に効率的です。結局のところ、アプリケーションがシステムルーチンを実行しているとき、またはシステム定義オブジェクトにメッセージを送信しているときは、ほとんどの場合、アセンブリコードを実行しています。

しかし、アプリケーションによっては、非常に計算量が多く、時間のかかるルーチンを持つ場合がある。
これは、アプリケーションがより遅いプラットフォームで実行されることを意図している場合や、時間のかかるルーチンを(何らかの理由で)効率的にコンパイルできない場合には、悪化する可能性がある。
この場合、これらのルーチンをアセンブリ言語で書き直すだけで、効率が大幅に向上することがあります。

1つのコードリソース内のすべてのルーチンは、同じ言語(GocまたはEsp)で記述する必要があります。
したがって、Espルーチンを1つ以上のリソースに分離する必要があります。
リソースが小さすぎると効率が低下するため、単純にすべてのEspルーチンを1つのリソースに配置することをお勧めします。
ルーチンを含むアセンブリファイルを作成し、Cヘッダファイル内のすべてのルーチンを\"extern\"として宣言します。
mkmfは、2つのリソースをコンパイルしてリンクするための適切な命令を自動的に生成します。

Espルーチンは、Cのpass-and-return規則に準拠するように記述する必要があります。
通常は、「pascal」規則を使用してルーチンを作成することをお勧めします。
この規則では、引数は渡されたのと同じ順序でスタックにプッシュされます。
たとえば、ルーチンMyFunc()に次の宣言があるとします。

```
extern word 
    _pascal MyFunc(word firstVar, 
        byte    secondVar,
        dword   thirdVar);
```

では、firstVarが最初にスタックにプッシュされ、次のsecondVarがプッシュされ(1バイトの長さしかありませんが、完全なワードを占めます)、次にthirdVarがプッシュされます(最初に上位ワード、次に下位ワード)。
アセンブリルーチンが戻ると、戻り値をaxにロードするだけで、この値が呼び出し側に返されます。
(バイトサイズの値はalで返され、dwordサイズの値はdx:axで返されます)。

pascal呼び出し規則を使用する場合は、渡された引数を宣言するためにEspの手法を使用できます。C宣言と同じ順序で宣言します。
たとえば、MyFunc()のC宣言が上記のようになっているとします。
アセンブリリソースでは、次のようにMyFunc()を記述できます。

```
MyFunc proc far firstVar:word, secondVar:byte, thirdVar:dword

.enter

; routine code... return value ends up in ax

.leave

	ret

MyFunc endp
```

ルーチンでCの呼び出し規則を使用する必要がある場合は、引数は宣言された順序とは逆の順序で渡されることに注意してください。
これは、ルーチンに可変数の引数がある場合には便利ですが、それ以外の状況では厄介なだけです。

### E.2 ESPライブラリの作成

GocまたはEspコードのいずれかでルーチンを呼び出すことができるライブラリをEspで作成することもできます。
これは、Gocでライブラリを作成するのとよく似ています。
すべてのエクスポートされたルーチンを、pascalのパス・アンド・リターン規則を使用するように記述するだけです。
GocヘッダーファイルとEspヘッダーファイルの両方を作成することを忘れないでください。そうすれば、アプリケーションはこれらのうち適切なものを含めることができます。
これらのヘッダー・ファイルの両方が連携して維持され、ライブラリーの状態を正確に反映していることを確認してください。

オブジェクトライブラリを作成する場合は、Espireヘッダーファイル(.uih)と、GocおよびEspヘッダーファイルを作成する必要があります。
3つのヘッダーファイルはすべて、タンデムに維持する必要があります。
Espireについては、で説明します。[UIコンパイラ、第4章](euic.md)ボタンをクリックし

[UIコンパイラ](euic.md)\<-[目次](../esp.md)
